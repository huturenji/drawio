<mxfile host="app.diagrams.net" modified="2022-06-09T02:26:23.682Z" agent="5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36" etag="KcPQoO6EP4L0HdLkBBCi" version="18.0.2" type="github" pages="2">
  <diagram id="l7loPyiOmaxG58bgO53x" name="B+H5授权流程">
    <mxGraphModel dx="2489" dy="706" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-69" value="&lt;span style=&quot;font-size: 11px; text-align: left; background-color: rgb(255, 255, 255);&quot;&gt;②、access_token&lt;/span&gt;存在且无效，并且refresh_token有效" style="shape=umlFrame;whiteSpace=wrap;html=1;width=107;height=70;" parent="1" vertex="1">
          <mxGeometry x="286" y="1520" width="1310" height="250" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-64" value="&lt;span style=&quot;font-size: 11px; text-align: left; background-color: rgb(255, 255, 255);&quot;&gt;①、access_token&lt;/span&gt;不存在或者&lt;span style=&quot;font-size: 11px; text-align: left; background-color: rgb(255, 255, 255);&quot;&gt;access_token&lt;/span&gt;与refresh_token均无效(无效包括过期、内容非法等)" style="shape=umlFrame;whiteSpace=wrap;html=1;width=110;height=90;" parent="1" vertex="1">
          <mxGeometry x="285" y="434" width="1300" height="1066" as="geometry" />
        </mxCell>
        <mxCell id="6bxtVyM5R0hy2lYG2gwJ-41" value="B+ keycloak&lt;br&gt;&amp;nbsp;js-adapter" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="350" y="80" width="100" height="2270" as="geometry" />
        </mxCell>
        <mxCell id="6bxtVyM5R0hy2lYG2gwJ-69" value="7、判断本地access_token状态" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="6bxtVyM5R0hy2lYG2gwJ-41" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="50" y="274" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="80" y="274" />
            </Array>
            <mxPoint x="55" y="294" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-29" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="6bxtVyM5R0hy2lYG2gwJ-41" vertex="1">
          <mxGeometry x="45" y="1126" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-30" value="17、获取16步返回的code" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1.283;entryY=0.478;entryDx=0;entryDy=0;entryPerimeter=0;" parent="6bxtVyM5R0hy2lYG2gwJ-41" target="UhIwf-_oe5DcTIy6UfvT-29" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="50" y="1136" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="75" y="1136" />
              <mxPoint x="75" y="1145" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-37" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="6bxtVyM5R0hy2lYG2gwJ-41" vertex="1">
          <mxGeometry x="45" y="1360" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-38" value="20、返回access_token，本地存储access_token,refresh_token" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="6bxtVyM5R0hy2lYG2gwJ-41" target="UhIwf-_oe5DcTIy6UfvT-37" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="45" y="1340" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="75" y="1340" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-50" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="6bxtVyM5R0hy2lYG2gwJ-41" vertex="1">
          <mxGeometry x="45" y="294" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-77" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="6bxtVyM5R0hy2lYG2gwJ-41" vertex="1">
          <mxGeometry x="45" y="1483" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-78" value="1、获取本地存储的refresh_token" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="6bxtVyM5R0hy2lYG2gwJ-41" target="UhIwf-_oe5DcTIy6UfvT-77" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="45" y="1453" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="75" y="1453" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-80" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="6bxtVyM5R0hy2lYG2gwJ-41" vertex="1">
          <mxGeometry x="45" y="1640" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-81" value="4、返回access_token，更新本地存储的access_token与refresh_token" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="6bxtVyM5R0hy2lYG2gwJ-41" target="UhIwf-_oe5DcTIy6UfvT-80" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="53" y="1620" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="83" y="1620" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="6bxtVyM5R0hy2lYG2gwJ-53" value="IDM keycloak Realm&lt;br&gt;(伴正事keycloak)" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="1241" y="80" width="100" height="2500" as="geometry" />
        </mxCell>
        <mxCell id="6bxtVyM5R0hy2lYG2gwJ-58" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="6bxtVyM5R0hy2lYG2gwJ-53" vertex="1">
          <mxGeometry x="45" y="63" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="6bxtVyM5R0hy2lYG2gwJ-59" value="1、配置第三方应用用于认证的client&lt;br&gt;(clientId,clientSecret)" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="6bxtVyM5R0hy2lYG2gwJ-53" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="50" y="50" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="75" y="50" />
            </Array>
            <mxPoint x="55" y="70" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-13" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="6bxtVyM5R0hy2lYG2gwJ-53" vertex="1">
          <mxGeometry x="45" y="660" width="10" height="80" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-16" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="6bxtVyM5R0hy2lYG2gwJ-53" vertex="1">
          <mxGeometry x="45" y="700" width="10" height="15" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-17" value="11、校验cookie判断是否登录，进行认证&lt;br&gt;cookie校验失败，&lt;br&gt;则弹出IDM keycloak登录页面，&lt;br&gt;用户登录后继续12步流程)" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="6bxtVyM5R0hy2lYG2gwJ-53" target="UhIwf-_oe5DcTIy6UfvT-16" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="45" y="680" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="75" y="680" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-21" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="6bxtVyM5R0hy2lYG2gwJ-53" vertex="1">
          <mxGeometry x="45" y="844" width="10" height="80" as="geometry" />
        </mxCell>
        <mxCell id="6bxtVyM5R0hy2lYG2gwJ-54" value="&amp;nbsp;B+ keycloak Realm" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="850" y="80" width="100" height="2490" as="geometry" />
        </mxCell>
        <mxCell id="6bxtVyM5R0hy2lYG2gwJ-60" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="6bxtVyM5R0hy2lYG2gwJ-54" vertex="1">
          <mxGeometry x="45" y="94" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="6bxtVyM5R0hy2lYG2gwJ-61" value="2、配置IDP&lt;br&gt;①IDM分配的clientId，clientSecret&lt;br&gt;②IDM Realm标准协议接口&lt;br&gt;AuthorizationUrl、TokenUrl、UserInfoUrl、公钥" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="6bxtVyM5R0hy2lYG2gwJ-54" target="6bxtVyM5R0hy2lYG2gwJ-60" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="55" y="74" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="75" y="74" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-6" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="6bxtVyM5R0hy2lYG2gwJ-54" vertex="1">
          <mxGeometry x="45" y="410" width="10" height="80" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-9" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="6bxtVyM5R0hy2lYG2gwJ-54" vertex="1">
          <mxGeometry x="45" y="530" width="10" height="80" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-18" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="6bxtVyM5R0hy2lYG2gwJ-54" vertex="1">
          <mxGeometry x="45" y="791" width="10" height="284" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-27" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="6bxtVyM5R0hy2lYG2gwJ-54" vertex="1">
          <mxGeometry x="45" y="1001" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-28" value="15、创建关联用户或者更新用户" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="6bxtVyM5R0hy2lYG2gwJ-54" target="UhIwf-_oe5DcTIy6UfvT-27" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="55" y="981" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="85" y="981" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-34" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="6bxtVyM5R0hy2lYG2gwJ-54" vertex="1">
          <mxGeometry x="45" y="1221" width="10" height="80" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-89" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="6bxtVyM5R0hy2lYG2gwJ-54" vertex="1">
          <mxGeometry x="45" y="1539" width="10" height="60" as="geometry" />
        </mxCell>
        <mxCell id="6bxtVyM5R0hy2lYG2gwJ-55" value="APP" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="-120" y="80" width="100" height="2360" as="geometry" />
        </mxCell>
        <mxCell id="6bxtVyM5R0hy2lYG2gwJ-56" value="" style="shape=umlLifeline;participant=umlActor;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;verticalAlign=top;spacingTop=36;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="-240" y="80" width="20" height="2360" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-7" value="8、location.href=&lt;span style=&quot;text-align: left;&quot;&gt;auth-server-url&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;text-align: left;&quot;&gt;/realms/realm/protocol/openid-connect/auth&lt;/span&gt;&lt;br style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;text-align: left;&quot;&gt;(redirect_uri&amp;amp;client_id&amp;amp;response_type=code&amp;amp;scope=openid&amp;amp;code_challenge&amp;amp;&lt;/span&gt;&lt;br style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;text-align: left;&quot;&gt;code_challenge_method=S256&amp;amp;kc_idp_hint=IDP Alias)&lt;/span&gt;" style="html=1;verticalAlign=bottom;endArrow=block;entryX=0;entryY=0;rounded=0;" parent="1" source="6bxtVyM5R0hy2lYG2gwJ-41" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="410" y="501" as="sourcePoint" />
            <mxPoint x="895" y="501" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-8" value="9-1、303重定向B+ realm用于第三方IDP授权的接口，使用第三方身份认证&lt;br&gt;realm/broker/IDP Alias/login(&lt;span style=&quot;text-align: left;&quot;&gt;client_id&lt;/span&gt;)" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;exitX=0;exitY=0.95;rounded=0;" parent="1" source="UhIwf-_oe5DcTIy6UfvT-6" target="6bxtVyM5R0hy2lYG2gwJ-41" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="400" y="566" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-10" value="9-2、请求&amp;nbsp; realm/broker/IDP Alias/login(&lt;span style=&quot;text-align: left;&quot;&gt;client_id&lt;/span&gt;)" style="html=1;verticalAlign=bottom;endArrow=block;entryX=0;entryY=0;rounded=0;" parent="1" source="6bxtVyM5R0hy2lYG2gwJ-41" target="UhIwf-_oe5DcTIy6UfvT-9" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="420" y="610" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-11" value="10-1、303重定向IDM Realm请求授权&lt;br&gt;&lt;div style=&quot;text-align: left;&quot;&gt;IDM Realm/protocol/openid-connect/auth(clientId,scope,redirectUri,response_type=code)&lt;/div&gt;" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;exitX=0;exitY=0.95;rounded=0;" parent="1" source="UhIwf-_oe5DcTIy6UfvT-9" target="6bxtVyM5R0hy2lYG2gwJ-41" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="410" y="685" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-14" value="10-2、请求IDM Realm/protocol/openid-connect/auth(&lt;span style=&quot;text-align: left;&quot;&gt;clientId,scope,redirectUri,response_type=code)&lt;/span&gt;" style="html=1;verticalAlign=bottom;endArrow=block;entryX=0;entryY=0;rounded=0;" parent="1" target="UhIwf-_oe5DcTIy6UfvT-13" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="410" y="740" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-15" value="12-1、302重定向回B+ realm/broker/IDP Alias/endpoint(Code)" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;exitX=-0.141;exitY=0.828;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="UhIwf-_oe5DcTIy6UfvT-16" target="6bxtVyM5R0hy2lYG2gwJ-41" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="410" y="792" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-19" value="12-2、请求B+ realm/broker/IDP Alias/endpoint(Code)" style="html=1;verticalAlign=bottom;endArrow=block;entryX=0;entryY=0;rounded=0;" parent="1" source="6bxtVyM5R0hy2lYG2gwJ-41" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="410" y="904" as="sourcePoint" />
            <mxPoint x="895" y="904.0000000000011" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-20" value="16、302重定向第8步中传递的&lt;span style=&quot;text-align: left;&quot;&gt;redirect_uri&lt;/span&gt;(code)" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;exitX=0;exitY=0.95;rounded=0;" parent="1" target="6bxtVyM5R0hy2lYG2gwJ-41" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="410" y="1140" as="targetPoint" />
            <mxPoint x="895" y="1137.25" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-22" value="13、获取token&lt;br&gt;请求IDM Realm/protocol/openid-connect/token(Code)" style="html=1;verticalAlign=bottom;endArrow=block;entryX=0;entryY=0;rounded=0;" parent="1" target="UhIwf-_oe5DcTIy6UfvT-21" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="899.0714285714284" y="924" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-23" value="14、返回idtoken,accesstoken,refreshtoken" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;exitX=0;exitY=0.95;rounded=0;" parent="1" source="UhIwf-_oe5DcTIy6UfvT-21" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="899.0714285714284" y="1000" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-35" value="18、ajax以post方式请求获取token接口&lt;br&gt;&lt;span style=&quot;text-align: left;&quot;&gt;auth-server-url&lt;/span&gt;&lt;span style=&quot;text-align: left;&quot;&gt;/auth/realms/realm/protocol/openid-connect/token&lt;/span&gt;&lt;br style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;text-align: left;&quot;&gt;(code,grant_type=authorization_code,client_id,redirect_uri)&lt;/span&gt;" style="html=1;verticalAlign=bottom;endArrow=block;entryX=0;entryY=0;rounded=0;" parent="1" source="6bxtVyM5R0hy2lYG2gwJ-41" target="UhIwf-_oe5DcTIy6UfvT-34" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="399.07142857142844" y="1301" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-36" value="19、返回第三方access_token,refresh_token" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;exitX=0;exitY=0.95;rounded=0;" parent="1" source="UhIwf-_oe5DcTIy6UfvT-34" target="6bxtVyM5R0hy2lYG2gwJ-41" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="399.07142857142844" y="1377" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-48" value="B+ H5应用页面" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="20" y="80" width="110" height="2262.5" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-98" value="&lt;div style=&quot;text-align: left;&quot;&gt;6、获取&lt;span style=&quot;text-align: left;&quot;&gt;access_token&lt;/span&gt;(client_id,realm,auth-server-url)&lt;/div&gt;&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;font-size: 10px; text-align: center; background-color: rgb(248, 249, 250);&quot;&gt;a、realm是B+keycloak的realm，&lt;/span&gt;&lt;span style=&quot;background-color: rgb(248, 249, 250); font-size: 10px; text-align: center;&quot;&gt;不同环境realm不一样，&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;background-color: rgb(248, 249, 250); font-size: 10px; text-align: center;&quot;&gt;例如UAT为bplusuat，生产环境为plusprod&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;font-size: 10px; text-align: center; background-color: rgb(248, 249, 250);&quot;&gt;b、&lt;/span&gt;&lt;span style=&quot;font-size: 10px; text-align: center; background-color: rgb(248, 249, 250);&quot;&gt;anth-server-url是B+keycloak的域名地址&lt;/span&gt;&lt;span style=&quot;font-size: 11px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" parent="UhIwf-_oe5DcTIy6UfvT-48" target="6bxtVyM5R0hy2lYG2gwJ-41" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="60" y="261" as="sourcePoint" />
            <mxPoint x="199.5" y="261" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-72" value="&lt;span style=&quot;font-size: 11px; text-align: left; background-color: rgb(255, 255, 255);&quot;&gt;③access_token&lt;/span&gt;存在且有效" style="shape=umlFrame;whiteSpace=wrap;html=1;width=107;height=65;" parent="1" vertex="1">
          <mxGeometry x="281" y="1805" width="1310" height="145" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-90" value="2、ajax以post方式请求获取token接口&lt;br&gt;&lt;span style=&quot;text-align: left;&quot;&gt;auth-server-url&lt;/span&gt;&lt;span style=&quot;text-align: left;&quot;&gt;/auth/realms/realm/protocol/openid-connect/token&lt;/span&gt;&lt;br style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;text-align: left;&quot;&gt;(&lt;span style=&quot;font-size: 11px;&quot;&gt;refresh_token&lt;/span&gt;,grant_type=&lt;span style=&quot;font-size: 11px;&quot;&gt;refresh_token&lt;/span&gt;,client_id)&lt;/span&gt;" style="html=1;verticalAlign=bottom;endArrow=block;entryX=0;entryY=0;rounded=0;exitX=0.5;exitY=0.678;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="6bxtVyM5R0hy2lYG2gwJ-41" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="398.96153846153857" y="1618" as="sourcePoint" />
            <mxPoint x="895" y="1618" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-91" value="3、返回access_token，refresh_token" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;exitX=0;exitY=0.95;rounded=0;" parent="1" source="UhIwf-_oe5DcTIy6UfvT-89" target="6bxtVyM5R0hy2lYG2gwJ-41" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="398.96153846153857" y="1676" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-93" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="1" vertex="1">
          <mxGeometry x="395" y="1882" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-94" value="返回access_token" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="1" target="UhIwf-_oe5DcTIy6UfvT-93" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="400" y="1870" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="428" y="1862" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="UhIwf-_oe5DcTIy6UfvT-96" value="返回&lt;span style=&quot;text-align: left;&quot;&gt;access_token&lt;/span&gt;" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;" parent="1" target="UhIwf-_oe5DcTIy6UfvT-48" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="400" y="2010" as="sourcePoint" />
            <mxPoint x="248.96153846153857" y="2010" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="6bxtVyM5R0hy2lYG2gwJ-62" value="3、打开APP" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" parent="1" target="6bxtVyM5R0hy2lYG2gwJ-55" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-230" y="180" as="sourcePoint" />
            <mxPoint x="-80.49999999999955" y="180" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="6bxtVyM5R0hy2lYG2gwJ-64" value="4、访问第三方应用" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" parent="1" source="6bxtVyM5R0hy2lYG2gwJ-56" target="6bxtVyM5R0hy2lYG2gwJ-55" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-230" y="267" as="sourcePoint" />
            <mxPoint x="-80.49999999999955" y="267" as="targetPoint" />
            <Array as="points">
              <mxPoint x="-150" y="240" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="6bxtVyM5R0hy2lYG2gwJ-65" value="5、打开第三方B+H5应用页面" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" parent="1" source="6bxtVyM5R0hy2lYG2gwJ-55" target="UhIwf-_oe5DcTIy6UfvT-48" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-80" y="308" as="sourcePoint" />
            <mxPoint x="50" y="260" as="targetPoint" />
            <Array as="points">
              <mxPoint y="260" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="37paYbiNbMrohzq2VaF8-1" value="浏览器" style="shape=umlFrame;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="10" y="40" width="460" height="100" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="bfjFzJn862lABcE6q1Vu" name="B+H5授权流程-1">
    <mxGraphModel dx="2058" dy="523" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-1" value="&lt;span style=&quot;font-size: 11px; text-align: left; background-color: rgb(255, 255, 255);&quot;&gt;②、access_token&lt;/span&gt;存在且无效，并且refresh_token有效" style="shape=umlFrame;whiteSpace=wrap;html=1;width=107;height=70;" parent="1" vertex="1">
          <mxGeometry x="270" y="1520" width="1310" height="250" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-2" value="&lt;span style=&quot;font-size: 11px; text-align: left; background-color: rgb(255, 255, 255);&quot;&gt;①、access_token&lt;/span&gt;不存在或者&lt;span style=&quot;font-size: 11px; text-align: left; background-color: rgb(255, 255, 255);&quot;&gt;access_token&lt;/span&gt;与refresh_token均无效(无效包括过期、内容非法等)" style="shape=umlFrame;whiteSpace=wrap;html=1;width=110;height=90;" parent="1" vertex="1">
          <mxGeometry x="272" y="379" width="1300" height="1121" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-3" value="B+ keycloak&lt;br&gt;&amp;nbsp;js-adapter" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="350" y="80" width="100" height="2270" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-4" value="7、判断本地access_token状态" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="s-siiSZIk8oDTdAX0CZ9-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="50" y="242" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="80" y="242" />
            </Array>
            <mxPoint x="55" y="262" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-5" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="s-siiSZIk8oDTdAX0CZ9-3" vertex="1">
          <mxGeometry x="45" y="1126" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-6" value="17、通过页面url获取16步返回的code" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1.283;entryY=0.478;entryDx=0;entryDy=0;entryPerimeter=0;" parent="s-siiSZIk8oDTdAX0CZ9-3" target="s-siiSZIk8oDTdAX0CZ9-5" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="50" y="1136" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="75" y="1136" />
              <mxPoint x="75" y="1145" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-7" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="s-siiSZIk8oDTdAX0CZ9-3" vertex="1">
          <mxGeometry x="45" y="1360" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-8" value="20、返回access_token，本地存储access_token,refresh_token" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="s-siiSZIk8oDTdAX0CZ9-3" target="s-siiSZIk8oDTdAX0CZ9-7" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="45" y="1340" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="75" y="1340" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-9" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="s-siiSZIk8oDTdAX0CZ9-3" vertex="1">
          <mxGeometry x="45" y="262" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-10" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="s-siiSZIk8oDTdAX0CZ9-3" vertex="1">
          <mxGeometry x="45" y="1483" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-11" value="1、获取本地存储的refresh_token" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="s-siiSZIk8oDTdAX0CZ9-3" target="s-siiSZIk8oDTdAX0CZ9-10" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="45" y="1453" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="75" y="1453" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-12" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="s-siiSZIk8oDTdAX0CZ9-3" vertex="1">
          <mxGeometry x="45" y="1640" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-13" value="4、返回access_token，更新本地存储的access_token与refresh_token" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="s-siiSZIk8oDTdAX0CZ9-3" target="s-siiSZIk8oDTdAX0CZ9-12" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="53" y="1620" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="83" y="1620" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-57" value="&lt;span style=&quot;font-size: 11px;&quot;&gt;8、location.href=&lt;/span&gt;&lt;span style=&quot;font-size: 11px; text-align: left;&quot;&gt;auth-server-url&lt;/span&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;font-size: 11px; text-align: left;&quot;&gt;/realms/realm/protocol/openid-connect/auth&lt;/span&gt;&lt;br style=&quot;font-size: 11px; text-align: left;&quot;&gt;&lt;span style=&quot;font-size: 11px; text-align: left;&quot;&gt;(redirect_uri&amp;amp;client_id&amp;amp;response_type=code&lt;br&gt;&amp;amp;scope=openid&amp;amp;code_challenge&amp;amp;&lt;/span&gt;&lt;br style=&quot;font-size: 11px; text-align: left;&quot;&gt;&lt;span style=&quot;font-size: 11px; text-align: left;&quot;&gt;code_challenge_method=S256&amp;amp;kc_idp_hint=IDP Alias)&lt;/span&gt;" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;fontSize=9;" parent="s-siiSZIk8oDTdAX0CZ9-3" target="s-siiSZIk8oDTdAX0CZ9-56" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="50" y="410" as="sourcePoint" />
            <mxPoint x="130" y="410" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-14" value="IDM keycloak Realm&lt;br&gt;(伴正事keycloak)" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="1290" y="80" width="100" height="2500" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-15" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="s-siiSZIk8oDTdAX0CZ9-14" vertex="1">
          <mxGeometry x="45" y="63" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-16" value="1、配置第三方应用用于认证的client&lt;br&gt;(clientId,clientSecret)" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="s-siiSZIk8oDTdAX0CZ9-14" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="50" y="50" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="75" y="50" />
            </Array>
            <mxPoint x="55" y="70" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-17" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="s-siiSZIk8oDTdAX0CZ9-14" vertex="1">
          <mxGeometry x="45" y="660" width="10" height="80" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-18" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="s-siiSZIk8oDTdAX0CZ9-14" vertex="1">
          <mxGeometry x="45" y="700" width="10" height="15" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-19" value="11、校验cookie判断是否登录，进行认证&lt;br&gt;(如果cookie校验失败，则弹出IDM keycloak登录页面，&lt;br&gt;用户登录后继续12步流程)" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="s-siiSZIk8oDTdAX0CZ9-14" target="s-siiSZIk8oDTdAX0CZ9-18" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="45" y="680" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="75" y="680" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-20" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="s-siiSZIk8oDTdAX0CZ9-14" vertex="1">
          <mxGeometry x="45" y="844" width="10" height="80" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-21" value="&amp;nbsp;B+ keycloak Realm" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="990" y="80" width="100" height="2490" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-22" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="s-siiSZIk8oDTdAX0CZ9-21" vertex="1">
          <mxGeometry x="45" y="94" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-23" value="2、配置IDP&lt;br&gt;①IDM分配的clientId，clientSecret&lt;br&gt;②IDM Realm标准协议接口&lt;br&gt;AuthorizationUrl、TokenUrl、UserInfoUrl、公钥" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="s-siiSZIk8oDTdAX0CZ9-21" target="s-siiSZIk8oDTdAX0CZ9-22" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="55" y="74" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="75" y="74" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-24" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="s-siiSZIk8oDTdAX0CZ9-21" vertex="1">
          <mxGeometry x="45" y="410" width="10" height="80" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-25" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="s-siiSZIk8oDTdAX0CZ9-21" vertex="1">
          <mxGeometry x="45" y="530" width="10" height="80" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-26" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="s-siiSZIk8oDTdAX0CZ9-21" vertex="1">
          <mxGeometry x="45" y="791" width="10" height="284" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-27" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="s-siiSZIk8oDTdAX0CZ9-21" vertex="1">
          <mxGeometry x="45" y="1001" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-28" value="15、创建关联用户或者更新用户" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="s-siiSZIk8oDTdAX0CZ9-21" target="s-siiSZIk8oDTdAX0CZ9-27" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="55" y="981" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="85" y="981" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-29" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="s-siiSZIk8oDTdAX0CZ9-21" vertex="1">
          <mxGeometry x="45" y="1221" width="10" height="80" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-30" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="s-siiSZIk8oDTdAX0CZ9-21" vertex="1">
          <mxGeometry x="45" y="1539" width="10" height="60" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-31" value="APP" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="-120" y="80" width="100" height="2360" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-32" value="" style="shape=umlLifeline;participant=umlActor;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;verticalAlign=top;spacingTop=36;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="-240" y="80" width="20" height="2360" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-34" value="9、303重定向B+ realm用于第三方IDP授权的接口，使用第三方身份认证&lt;br&gt;realm/broker/IDP Alias/login(&lt;span style=&quot;text-align: left;&quot;&gt;client_id&lt;/span&gt;)" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;exitX=0;exitY=0.95;rounded=0;" parent="1" source="s-siiSZIk8oDTdAX0CZ9-24" target="s-siiSZIk8oDTdAX0CZ9-56" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="400" y="566" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-35" value="9-1、请求&amp;nbsp; realm/broker/IDP Alias/login(&lt;span style=&quot;text-align: left;&quot;&gt;client_id&lt;/span&gt;)" style="html=1;verticalAlign=bottom;endArrow=block;entryX=0;entryY=0;rounded=0;" parent="1" source="s-siiSZIk8oDTdAX0CZ9-56" target="s-siiSZIk8oDTdAX0CZ9-25" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="420" y="610" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-36" value="10、303重定向IDM Realm请求授权&lt;br&gt;&lt;div style=&quot;text-align: left;&quot;&gt;IDM Realm/protocol/openid-connect/auth&lt;/div&gt;&lt;div style=&quot;text-align: left;&quot;&gt;(clientId,scope,redirectUri,response_type=code)&lt;/div&gt;" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;exitX=0;exitY=0.95;rounded=0;" parent="1" source="s-siiSZIk8oDTdAX0CZ9-25" target="s-siiSZIk8oDTdAX0CZ9-56" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="410" y="685" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-37" value="10-1、请求IDM Realm/protocol/openid-connect/auth(&lt;span style=&quot;text-align: left;&quot;&gt;clientId,scope,redirectUri,response_type=code)&lt;/span&gt;" style="html=1;verticalAlign=bottom;endArrow=block;entryX=0;entryY=0;rounded=0;" parent="1" source="s-siiSZIk8oDTdAX0CZ9-56" target="s-siiSZIk8oDTdAX0CZ9-17" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="410" y="740" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-38" value="12、302重定向回B+ realm/broker/IDP Alias/endpoint(Code)" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;exitX=-0.141;exitY=0.828;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="s-siiSZIk8oDTdAX0CZ9-18" target="s-siiSZIk8oDTdAX0CZ9-56" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="410" y="792" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-39" value="12-1、请求B+ realm/broker/IDP Alias/endpoint(Code)" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" parent="1" source="s-siiSZIk8oDTdAX0CZ9-56" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="410" y="904" as="sourcePoint" />
            <mxPoint x="1040" y="900" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-40" value="16、302重定向第8步中传递的&lt;span style=&quot;text-align: left;&quot;&gt;redirect_uri&lt;/span&gt;(code)" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;exitX=0.1;exitY=0.94;rounded=0;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="s-siiSZIk8oDTdAX0CZ9-26" target="s-siiSZIk8oDTdAX0CZ9-56" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="410" y="1140" as="targetPoint" />
            <mxPoint x="895" y="1137.25" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-41" value="13、获取token&lt;br&gt;请求IDM Realm/protocol/openid-connect/token(Code)" style="html=1;verticalAlign=bottom;endArrow=block;entryX=0;entryY=0;rounded=0;" parent="1" target="s-siiSZIk8oDTdAX0CZ9-20" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1040" y="924" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-42" value="14、返回idtoken,accesstoken,refreshtoken" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;exitX=0;exitY=0.95;rounded=0;" parent="1" source="s-siiSZIk8oDTdAX0CZ9-20" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1040" y="1000" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-43" value="18、ajax以post方式请求获取token接口&lt;br&gt;&lt;span style=&quot;text-align: left;&quot;&gt;auth-server-url&lt;/span&gt;&lt;span style=&quot;text-align: left;&quot;&gt;/auth/realms/realm/protocol/openid-connect/token&lt;/span&gt;&lt;br style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;text-align: left;&quot;&gt;(code,grant_type=authorization_code,client_id,redirect_uri)&lt;/span&gt;" style="html=1;verticalAlign=bottom;endArrow=block;entryX=0;entryY=0;rounded=0;" parent="1" source="s-siiSZIk8oDTdAX0CZ9-3" target="s-siiSZIk8oDTdAX0CZ9-29" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="399.07142857142844" y="1301" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-44" value="19、返回第三方access_token,refresh_token" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;exitX=0;exitY=0.95;rounded=0;" parent="1" source="s-siiSZIk8oDTdAX0CZ9-29" target="s-siiSZIk8oDTdAX0CZ9-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="399.07142857142844" y="1377" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-45" value="B+ H5应用页面" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="10" y="80" width="110" height="2262.5" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-46" value="&lt;div style=&quot;text-align: left;&quot;&gt;&lt;div&gt;6、获取access_token&lt;/div&gt;&lt;div&gt;(client_id,realm,auth-server-url)&lt;/div&gt;&lt;div&gt;a、realm是B+keycloak的realm，不同环境realm不一样，&lt;/div&gt;&lt;div&gt;例如UAT为bplusuat，生产环境为plusprod&lt;/div&gt;&lt;div&gt;b、anth-server-url是B+keycloak的域名地址&lt;/div&gt;&lt;/div&gt;" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" parent="s-siiSZIk8oDTdAX0CZ9-45" edge="1" target="s-siiSZIk8oDTdAX0CZ9-3">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="60" y="248" as="sourcePoint" />
            <mxPoint x="379.5" y="248" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-47" value="&lt;span style=&quot;font-size: 11px; text-align: left; background-color: rgb(255, 255, 255);&quot;&gt;③access_token&lt;/span&gt;存在且有效" style="shape=umlFrame;whiteSpace=wrap;html=1;width=107;height=65;" parent="1" vertex="1">
          <mxGeometry x="265" y="1805" width="1310" height="145" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-48" value="2、ajax以post方式请求获取token接口&lt;br&gt;&lt;span style=&quot;text-align: left;&quot;&gt;auth-server-url&lt;/span&gt;&lt;span style=&quot;text-align: left;&quot;&gt;/auth/realms/realm/protocol/openid-connect/token&lt;/span&gt;&lt;br style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;text-align: left;&quot;&gt;(&lt;span style=&quot;font-size: 11px;&quot;&gt;refresh_token&lt;/span&gt;,grant_type=&lt;span style=&quot;font-size: 11px;&quot;&gt;refresh_token&lt;/span&gt;,client_id)&lt;/span&gt;" style="html=1;verticalAlign=bottom;endArrow=block;entryX=0.5;entryY=-0.017;rounded=0;exitX=0.5;exitY=0.678;exitDx=0;exitDy=0;exitPerimeter=0;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" source="s-siiSZIk8oDTdAX0CZ9-3" target="s-siiSZIk8oDTdAX0CZ9-30" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="398.96153846153857" y="1618" as="sourcePoint" />
            <mxPoint x="895" y="1618" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-49" value="3、返回access_token，refresh_token" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;exitX=0;exitY=0.95;rounded=0;" parent="1" source="s-siiSZIk8oDTdAX0CZ9-30" target="s-siiSZIk8oDTdAX0CZ9-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="398.96153846153857" y="1676" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-50" value="" style="html=1;points=[];perimeter=orthogonalPerimeter;" parent="1" vertex="1">
          <mxGeometry x="395" y="1882" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-51" value="返回access_token" style="edgeStyle=orthogonalEdgeStyle;html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;entryX=1;entryY=0;" parent="1" target="s-siiSZIk8oDTdAX0CZ9-50" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="400" y="1870" as="sourcePoint" />
            <Array as="points">
              <mxPoint x="428" y="1862" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-52" value="返回&lt;span style=&quot;text-align: left;&quot;&gt;access_token&lt;/span&gt;" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;" parent="1" target="s-siiSZIk8oDTdAX0CZ9-45" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="400" y="2010" as="sourcePoint" />
            <mxPoint x="248.96153846153857" y="2010" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-53" value="3、打开APP" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" parent="1" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-230" y="172" as="sourcePoint" />
            <mxPoint x="-70.5" y="172" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-54" value="4、访问第三方应用" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" parent="1" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-230.5" y="216" as="sourcePoint" />
            <mxPoint x="-70.5" y="216" as="targetPoint" />
            <Array as="points">
              <mxPoint x="-150" y="216" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-55" value="5、打开第三方B+ H5应用页面" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" parent="1" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-70.5" y="228" as="sourcePoint" />
            <mxPoint x="679.5" y="228" as="targetPoint" />
            <Array as="points">
              <mxPoint y="228" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-56" value="浏览器" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fontSize=9;" parent="1" vertex="1">
          <mxGeometry x="630" y="80" width="100" height="1950" as="geometry" />
        </mxCell>
        <mxCell id="s-siiSZIk8oDTdAX0CZ9-59" value="&lt;span style=&quot;font-size: 11px;&quot;&gt;8-1、打开页面&lt;/span&gt;&lt;span style=&quot;font-size: 11px; text-align: left;&quot;&gt;auth-server-url&lt;/span&gt;&lt;br style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;font-size: 11px; text-align: left;&quot;&gt;/realms/realm/protocol/openid-connect/auth&lt;/span&gt;&lt;br style=&quot;font-size: 11px; text-align: left;&quot;&gt;&lt;span style=&quot;font-size: 11px; text-align: left;&quot;&gt;(redirect_uri&amp;amp;client_id&amp;amp;response_type=code&lt;br&gt;&amp;amp;scope=openid&amp;amp;code_challenge&amp;amp;&lt;/span&gt;&lt;br style=&quot;font-size: 11px; text-align: left;&quot;&gt;&lt;span style=&quot;font-size: 11px; text-align: left;&quot;&gt;code_challenge_method=S256&amp;amp;kc_idp_hint=IDP Alias)&lt;/span&gt;" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;fontSize=9;" parent="s-siiSZIk8oDTdAX0CZ9-56" target="s-siiSZIk8oDTdAX0CZ9-24" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="50" y="420" as="sourcePoint" />
            <mxPoint x="130" y="420" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="fcC5g_MVllTzewNXhIFa-2" value="5-1、打开第三方B+ H5应用页面" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;" edge="1" parent="s-siiSZIk8oDTdAX0CZ9-56" target="s-siiSZIk8oDTdAX0CZ9-45">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="50" y="170" as="sourcePoint" />
            <mxPoint x="130" y="170" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="0ZKT2LgD2NxVRFNizVJh-1" value="return" style="html=1;verticalAlign=bottom;endArrow=open;dashed=1;endSize=8;rounded=0;fontSize=9;" parent="1" target="s-siiSZIk8oDTdAX0CZ9-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="680" y="1170" as="sourcePoint" />
            <mxPoint x="720" y="1170" as="targetPoint" />
          </mxGeometry>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
